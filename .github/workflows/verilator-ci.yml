---
name: Verilator CI

'on':
  push:
    branches-ignore:
      - gh-pages
      - v**
  pull_request:
    branches-ignore:
      - gh-pages
      - v**
  workflow_dispatch:

jobs:
  build-verilator-image:
    runs-on: verilog-runner
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Verilator Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .ci/Dockerfile.verilator
          tags: axi-verilator:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Save Docker image
        run: docker save axi-verilator:latest | gzip > axi-verilator.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: verilator-image
          path: axi-verilator.tar.gz
          retention-days: 1

  verilator-lint-synth:
    needs: build-verilator-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: verilator-image

      - name: Load Docker image
        run: docker load < axi-verilator.tar.gz

      - name: Run Verilator lint on synthesis bench
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace/build \
            axi-verilator:latest \
            bash -c \
            "mkdir -p /workspace/build && \
             cd /workspace/build && \
             ../scripts/run_verilator.sh --lint-only"

  verilator-lint-tests:
    needs: build-verilator-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        test:
          - axi_addr_test
          - axi_atop_filter
          - axi_cdc
          - axi_delayer
          - axi_dw_downsizer
          - axi_dw_upsizer
          - axi_fifo
          - axi_isolate
          - axi_iw_converter
          - axi_lite_dw_converter
          - axi_lite_mailbox
          - axi_lite_regs
          - axi_lite_to_apb
          - axi_lite_to_axi
          - axi_lite_xbar
          - axi_modify_address
          - axi_serializer
          - axi_sim_mem
          - axi_to_axi_lite
          - axi_to_mem_banked
          - axi_xbar
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: verilator-image

      - name: Load Docker image
        run: docker load < axi-verilator.tar.gz

      - name: Run Verilator lint on ${{ matrix.test }}
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace/build \
            axi-verilator:latest \
            bash -c \
            "mkdir -p /workspace/build && \
             cd /workspace/build && \
             ../scripts/run_verilator.sh --test ${{ matrix.test }}"
